## 知识摘要

### 名词解释

#### 带宽&吞吐量&速率

将数据流比作水流：

**带宽**说的是水管，某个水管单位时间内最多允许流过的水的量

**速率**说的是水流，也就是水流的速度

**吞吐量**说的是实际上单位时间内流过的水量有多少

因此：

**带宽**描述水管的粗细，带宽越大表示水管越大

**吞吐量**描述实际某段时间内水管流过的水量

**速率**描述实际某刻水的流速

因此**吞吐量**和**速率**都是**动态**变化的，**带宽**是**静态**的

### 运输层

运输层为**不同应用进程**间提供通信

运输层使用**端口号**区分应用层的不同应用进程

- 服务器收到报文时，根据端口号将数据报分配给对应的

端口号只具有本地意义，同计算机中的相同端口号没有联系

- 熟知端口号：0~1023，这些端口号分配给TCP/IP体系中最重要的应用程序，例如：**DNS使用53，HTTP使用80，FTP使用21/20**

#### TCP



## 面经

### 为什么要有TCP/IP网络模型

对于同一台设备上的进程间通信，有很多种方式，比如有管道、消息队列、共享内存、信号等方式，而对于不同设备上的进程间通信，需要网络通信。

由于设备是多样的，所以为了兼容多种多样的设备，协商出了一套通用的网络协议——TCP/IP网络模型

### 简单介绍TCP/IP模型

TCP/IP模型可以分为四层：应用层、传输层、网络层、网络链路层/网络接口层

- 应用层：
  - **应用间通信。**应用间通信时将数据传递给传输层，通过传输层实现应用间通信，因此应用层只需要专注于为用户提供应用服务
  - 操作系统的用户态，传输层及以下为操作系统的内核态
  - HTTP、FTP、Telnet、DNS、SMTP
- 传输层：
  - **端到端（进程）间通信。**应用间数据传输的媒介
  - 发送方：传输层负责传输应用发出的数据
  - 接收方：传输层负责将数据传达到指定应用的进程（区分不同应用的方法为端口）
    - 常见端口：80为Web服务器端口，22为远程登录服务器端口。而对于浏览器（客户端）中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号。
  - TCP和UDP
    - TCP安全，可靠传输，拥有流量控制等保证可靠传输的机制
    - UDP实时性好，但不可靠传输（可以在应用层实现UDP可靠传输，但难度比较大）
    - MSS：TCP最大报文段长度，如果传输层数据包超过MSS，需要将数据包分块，每个分块称为一个TCP段。如果传输过程中丢失某个TCP段，只需要重新发送这个TCP段，而不用发送整个数据包
- 网络层：
  - 设备到设备之间的通信，处理**多个网络之间的通信**
  - IP协议
    - 如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的 IP 报文。
    - IP地址：
      - 对于 IPv4 协议， IP 地址共 32 位，分成了四段（比如，192.168.100.1），每段是 8 位。
      - IP地址分为网络号和主机号：网络号：标识IP地址属于哪个子网，主机号：标识同一子网下的不同主机
- 网络链路层：
  - **点到点之间的通信**，处理**单个网络内的通信**
  - 以太网
    - MAC地址：区别同一设备的不同接口

![img](../figure/计算机网络/tcpip参考模型.drawio.png)

![img](../figure/计算机网络/封装.png)

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。

### 键入网址到网页显示，期间发生了什么？

![简单的网络模型](../figure/计算机网络/2.jpg)

#### 主要步骤

1. 输入URL后，浏览器开始解析URL，得到Web服务器和文件名
2. 浏览器根据解析URL得到的信息（Web服务器和文件名）生成HTTP请求信息
3. DNS域名解析：根据DNS服务器查询服务器域名对应的IP地址（目标地址）
4. TCP建立连接，三次握手
5. HTTP请求信息从协议栈顶部往下传递，每经过一层，就加上一层对应协议的头部，最后生成一个网络包
6. 网卡驱动获取网络包后，将其包装为帧
7. 网卡将包转为电信号，通过网线发送出去
8. 数据经交换机和路由器不断转发，最终到达目标服务器
9. 目标服务器处理HTTP请求并返回HTTP报文
10. 浏览器获取返回HTTP报文后，解析渲染页面
11. 断开连接：TCP四次挥手

#### 解析URL

![URL 解析](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/3.jpg)

> 要是上图中的蓝色部分 URL 元素都省略了，那应该是请求哪个文件呢？

当没有路径名时，就代表访问根目录下事先设置的**默认文件**，也就是 `/index.html` 或者 `/default.html` 这些文件，这样就不会发生混乱了。

#### HTTP请求信息

##### 请求报文

请求行

- 方法
- URL
- 版本

消息头

- 首部字段名：字段值

消息体

- 数据

##### 响应报文

状态行

- 版本
- 状态码
- 短语

消息头

- 首部字段名：字段值

消息体

- 数据

![HTTP 的消息格式](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/4.jpg)

#### DNS域名解析

DNS服务器专门保存Web服务器域名和IP的对应关系

DNS服务器分为三层

- 根DNS服务器
- 顶级域DNS服务器
- 权威DNS服务器
- 本地DNS服务器

DNS服务器有四种

- 根DNS服务器
- 顶级域DNS服务器
- 权威DNS服务器
- **本地DNS服务器**

DNS中的域名使用句点分割，句点表示不同层次之间的间隔，并且越靠右的位置表示其层级越高

以URL：www.server.com为例，实际上域名末尾还有一个点，即www.server.com.，这个点表示根DNS服务器

- 根DNS服务器（.)
- 顶级域DNS服务器(.com)
- 权威DNS服务器(server.com)

根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中。

因此，客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器。

##### DNS域名解析工作流程

以域名www.server.com为例

1. 客户端得到Web域名后查看本地是否有该Web域名的缓存，这里的”本地“指：
   - **浏览器**是否有有该Web域名的缓存
   - **操作系统**是否有有该Web域名的缓存
   - **hosts 文件**是否有有该Web域名的缓存（hosts文件保存域名和ip的映射关系）
2. 如果本地没有Web域名的缓存，则客户端询问本地DNS服务器是否有对应的IP地址
3. 如果本地DNS服务器能找到该域名，则返回对应的IP地址；否则，本地DNS服务器进一步询问根域名服务器是否有该域名的IP地址
4. 根域名服务器不负责域名解析，但是可以引导顶级域DNS服务器：接收到本地DNS服务器的询问后，根据顶级域.com查找到对应的顶级域服务器，返回信息给本地DNS服务器：给他顶级域服务器地址，并让他询问对应顶级域服务器
5. 本地DNS收到根域名服务器发来的顶级域服务器地址后，对顶级域服务器询问是否有www.server.com的IP地址，顶级域服务器给出下一层权威域名服务器地址（.server.com)，并让本地DNS去询问它
6. 本地DNS收到顶级域服务器发来的权威域名服务器地址后，对权威域名服务器询问是否有www.server.com的IP地址，权威域名服务器给出www.server.com对应的IP地址
7. 本地DNS服务器收到IP地址后，将其返回给客户端，客户端和目标建立连接

综上：本地DNS一共要询问3次，每个域名服务器都只指路并不带路

![域名解析的工作流程](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/6.jpg)

#### 协议栈

协议栈包括了TCP/IP模型中的传输层和网络层，包含了TCP/UDP协议、IP协议以及ICMP和ARP协议

- `ICMP` 用于告知网络包传送过程中产生的错误以及各种控制信息。
- `ARP` 用于根据 IP 地址查询相应的以太网 MAC 地址。

